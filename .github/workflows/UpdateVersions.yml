name: Auto Version Bump by Project

on:
  push:
    branches:
      - master
  workflow_dispatch:

jobs:
  bump-versions:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Parse commit message
        id: parse
        run: |
          COMMIT_MSG=$(git log -1 --pretty=%B)
          echo "Commit: $COMMIT_MSG"

          # Match: [Project[,Project2,...]] bumpType:
          if [[ "$COMMIT_MSG" =~ ^\[([A-Za-z0-9_, ]+)\][[:space:]]*([a-zA-Z]+): ]]; then
            RAW_SCOPE="${BASH_REMATCH[1]}"
            BUMP_TYPE="${BASH_REMATCH[2],,}"  # Lowercase

            # Validate bump type
            if [[ "$BUMP_TYPE" != "major" && "$BUMP_TYPE" != "minor" && "$BUMP_TYPE" != "patch" ]]; then
              echo "âš ï¸ Invalid bump type: '$BUMP_TYPE'. Skipping version bump."
              echo "projects=" >> $GITHUB_OUTPUT
              echo "bump_type=none" >> $GITHUB_OUTPUT
              exit 0
            fi

            PROJECTS=$(echo "$RAW_SCOPE" | tr -d ' ' | tr ',' ' ')
            echo "projects=$PROJECTS" >> $GITHUB_OUTPUT
            echo "bump_type=$BUMP_TYPE" >> $GITHUB_OUTPUT
          else
            echo "âš ï¸ Commit message does not match expected format. Skipping version bump."
            echo "projects=" >> $GITHUB_OUTPUT
            echo "bump_type=none" >> $GITHUB_OUTPUT
          fi

      - name: Bump version.json for each project
        if: steps.parse.outputs.bump_type != 'none'
        run: |
          for PROJECT in ${{ steps.parse.outputs.projects }}; do
            VERSION_FILE="$PROJECT/version.json"
            echo "ðŸ“¦ Bumping $PROJECT (${{ steps.parse.outputs.bump_type }})"

            if [ ! -f "$VERSION_FILE" ]; then
              echo "Creating new version file for $PROJECT"
              echo '{"version": "0.0.0"}' > "$VERSION_FILE"
            fi

            VERSION=$(jq -r .version "$VERSION_FILE")
            echo "Version: $VERSION"
            IFS='.' read -r MAJOR MINOR PATCH <<< "$VERSION"
            echo "IFS: $IFS"

            case "${{ steps.parse.outputs.bump_type }}" in
              major)
                ((MAJOR++)); MINOR=0; PATCH=0 ;;
              minor)
                ((MINOR++)); PATCH=0 ;;
              patch)
                ((PATCH++)) ;;
            esac

            NEW_VERSION="$MAJOR.$MINOR.$PATCH"
            jq --arg v "$NEW_VERSION" '.version = $v' "$VERSION_FILE" > tmp.json && mv tmp.json "$VERSION_FILE"
            echo "âœ… $PROJECT bumped to $NEW_VERSION"
          done

      - name: Commit and push version changes
        run: |
          git config --global user.name "github-actions"
          git config --global user.email "github-actions@github.com"

          git add */version.json

          if git diff --cached --quiet; then
            echo "No version changes to commit."
          else
            git commit -m "ci: bump version(s)"
            git push
          fi
